{% extends "layout.html" %}
{% load widget_tweaks %}

{% block content %}

<div class="d-flex justify-content-center align-items-center mt-5 mb-3">
    <div class="col-md-7 col-lg-6">
        <div class="p-4 border rounded-3 shadow bg-light">
            <h2 class="mb-4 text-center">Редагувати продукт</h2>

            <form method="POST" enctype="multipart/form-data" id="product-form">
                {% csrf_token %}

                <div class="mb-3">
                    {{ form.category.label_tag }}
                    {{ form.category|add_class:"form-select" }}
                </div>
                <div class="mb-3">
                    {{ form.name.label_tag }}
                    {{ form.name|add_class:"form-control" }}
                </div>
                <div class="mb-3">
                    {{ form.description.label_tag }}
                    {{ form.description|add_class:"form-control" }}
                </div>
                <div class="mb-3">
                    {{ form.price.label_tag }}
                    {{ form.price|add_class:"form-control" }}
                </div>

                <div class="mb-3">
                    <h5 class="mt-0">Фото товару</h5>
                    <input type="file" name="images" id="product-images" multiple class="form-control mb-3">
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-success">Зберегти зміни</button>
                    <a class="btn btn-outline-danger" href="/products">Скасувати</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    FilePond.registerPlugin(FilePondPluginImagePreview);

    const inputElement = document.querySelector('#product-images');

    const pond = FilePond.create(inputElement, {
        allowMultiple: true,
        allowReorder: true,
        allowImagePreview: true,
        imagePreviewHeight: 150,
        server: {
            process: {
                url: "{% url 'products:upload_temp_image' %}",
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                onload: (response) => JSON.parse(response).file_id,
                onerror: (response) => console.log("Error:", response)
            },
            revert: (uniqueFileId, load, error) => {
                fetch("{% url 'products:delete_temp_image' %}", {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ file_id: uniqueFileId })
                })
                .then(res => res.json())
                .then(res => {
                    if(res.status === "ok") load();
                    else error(res.error || "Error deleting file");
                })
                .catch(err => error("Error deleting file"));
            }
        },
        files: [
            {% for img in product.images.all %}
            {
                source: '{{ img.image.url }}',
                options: {
                    {% comment %} type: 'local', {% endcomment %}
                    metadata: { file_id: '{{ img.id }}', priority: {{ img.priority }} }
                }
            },
            {% endfor %}
        ]


    });

    const form = document.querySelector('#product-form');
    form.addEventListener('submit', function() {
        pond.getFiles().forEach((file, index) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'images';
            input.value = file.serverId;
            input.dataset.priority = index;
            form.appendChild(input);
        });
    });
});
</script>
{% endblock %}
